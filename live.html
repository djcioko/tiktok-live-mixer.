<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Mixer Studio V16 - FULL VERTICAL</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>
    <style>
        body { background: #000; color: white; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: #151515; border-right: 1px solid #333; padding: 10px; display: flex; flex-direction: column; gap: 5px; overflow-y: auto; font-size: 11px; z-index: 10; }
        .main-stage { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #050505; position: relative; }
        
        /* Containerul 9:16 fixat sa ocupe inaltimea maxima */
        #canvas-container { height: 98vh; aspect-ratio: 9 / 16; position: relative; background: #111; border: 1px solid #444; overflow: hidden; }
        canvas { width: 100%; height: 100%; cursor: move; }
        
        .card { background: #222; padding: 8px; border-radius: 6px; margin-bottom: 5px; border-left: 3px solid #007bff; }
        .fx-card { border-left: 3px solid #ff0050; }
        button { width: 100%; padding: 7px; margin-top: 4px; cursor: pointer; background: #333; color: white; border: 1px solid #444; border-radius: 4px; font-weight: bold; font-size: 10px; }
        input[type="file"], select { width: 100%; background: #000; color: white; border: 1px solid #444; font-size: 10px; margin-top: 4px; padding: 3px; }
        .active-ai { background: #2ed573 !important; color: #000; }
        .active-fx { background: #ff0050 !important; color: white; }
        #status { text-align: center; font-weight: bold; padding: 5px; margin-bottom: 5px; border-radius: 4px; font-size: 10px; border: 1px solid #444; }
        label { font-size: 9px; color: #888; margin-top: 5px; display: block; }
    </style>
</head>
<body>

<div class="sidebar">
    <div id="status" style="background: #221111; color: #ff4444;">OFFLINE</div>
    
    <div class="card">
        <strong>1. CAMERA & AI:</strong>
        <select id="videoSource" onchange="startCamera()"></select>
        <button id="toggleAI" onclick="toggleAI()">AI CUT-OUT: OFF</button>
    </div>

    <div class="card fx-card">
        <strong>2. EFECT PULS (ENTER):</strong>
        <button id="toggleFX" onclick="toggleFX()">PULS FX: OFF</button>
        <label>Intensitate Puls / Miscare</label>
        <input type="range" id="fxPower" min="0" max="150" value="60">
    </div>

    <div class="card">
        <strong>3. FUNDAL:</strong>
        <select id="bgSource" onchange="handleBgChange(this.value)">
            <option value="black">Negru</option>
            <option value="green">Verde (Chroma)</option>
            <option value="photo">Imagine Upload</option>
        </select>
        <input type="file" id="bgInp" style="display:none" onchange="loadBgImage(event)">
    </div>

    <div class="card">
        <strong>4. SLOTURI DOCUMENTE (1-10):</strong>
        <button onclick="setupFirebase()" style="background:#444">⚙️ CONFIG FIREBASE</button>
        <div id="file-slots"></div>
    </div>
</div>

<div class="main-stage">
    <div id="canvas-container">
        <canvas id="c_out"></canvas>
    </div>
</div>

<video id="v_raw" autoplay muted playsinline style="display:none"></video>
<img id="img_bg_store" style="display:none">

<script>
    const video = document.getElementById('v_raw');
    const canvas = document.getElementById('c_out');
    const ctx = canvas.getContext('2d');
    const imgBg = document.getElementById('img_bg_store');
    
    let db, activeEl = null, lastId = null;
    let aiActive = false, fxActive = false;
    const renderW = 1080, renderH = 1920;
    let config = JSON.parse(localStorage.getItem('mixer_config_v16')) || {};

    // Creare sloturi fisiere
    const slotsDiv = document.getElementById('file-slots');
    for(let i=1; i<=10; i++) {
        slotsDiv.innerHTML += `<div style="margin-top:4px;">#${i}: <input type="file" id="f${i}" accept="video/*,image/*"></div>`;
    }

    // Configurare AI (Mediapipe)
    const selfie = new SelfieSegmentation({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
    selfie.setOptions({ modelSelection: 1 });
    selfie.onResults(drawAll);

    async function initCamera() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const select = document.getElementById('videoSource');
        devices.forEach(d => { if(d.kind==='videoinput'){ let o=document.createElement('option'); o.value=d.deviceId; o.text=d.label||'Camera'; select.appendChild(o); }});
        startCamera();
    }

    async function startCamera() {
        if (window.stream) window.stream.getTracks().forEach(t => t.stop());
        const id = document.getElementById('videoSource').value;
        const s = await navigator.mediaDevices.getUserMedia({video: {deviceId: id ? {exact: id} : undefined, width: 1280, height: 720}});
        window.stream = s; video.srcObject = s; video.play();
        renderLoop();
    }

    async function renderLoop() {
        if(video.readyState >= 2) await selfie.send({image: video});
        else drawAll({}); 
        requestAnimationFrame(renderLoop);
    }

    function drawAll(results) {
        canvas.width = renderW; canvas.height = renderH;
        
        // --- 1. FUNDAL (BACKGROUND) ---
        const bgType = document.getElementById('bgSource').value;
        if(bgType === 'green') { ctx.fillStyle = "#00ff00"; ctx.fillRect(0,0,renderW,renderH); }
        else if(bgType === 'photo' && imgBg.src) { ctx.drawImage(imgBg, 0, 0, renderW, renderH); }
        else { ctx.fillStyle = "#000"; ctx.fillRect(0,0,renderW,renderH); }

        // --- 2. CAMERA (FULL VERTICAL FILL) ---
        if (video.videoWidth > 0) {
            ctx.save();
            
            let sourceW = video.videoWidth;
            let sourceH = video.videoHeight;
            let targetRatio = renderW / renderH; 
            let drawSourceW = sourceH * targetRatio;
            let startX = (sourceW - drawSourceW) / 2;

            // Parametrii pentru Puls / Miscare
            let finalX = 0, finalY = 0, finalW = renderW, finalH = renderH;
            
            if(fxActive) {
                const t = Date.now() * 0.005;
                const pPower = document.getElementById('fxPower').value;
                const pulse = Math.sin(t * 2) * pPower;
                finalX = (Math.cos(t * 1.5) * (pPower/2)) - (pulse/2);
                finalY = (Math.sin(t * 1.2) * (pPower/2)) - (pulse/2);
                finalW = renderW + pulse;
                finalH = renderH + (pulse / targetRatio);
            }

            if (aiActive && results.segmentationMask) {
                ctx.save();
                ctx.drawImage(results.segmentationMask, 0, 0, renderW, renderH);
                ctx.globalCompositeOperation = 'source-in';
                ctx.drawImage(results.image, startX, 0, drawSourceW, sourceH, finalX, finalY, finalW, finalH);
                ctx.restore();
            } else {
                ctx.drawImage(video, startX, 0, drawSourceW, sourceH, finalX, finalY, finalW, finalH);
            }
            ctx.restore();
        }

        // --- 3. SLOTURI FISIERE (ELEMENTE ACTIVE) ---
        if (activeEl && lastId) {
            const c = config[lastId] || { posX: 0, posY: 0, scale: 1.0 };
            const elW = activeEl.videoWidth || activeEl.width;
            const elH = activeEl.videoHeight || activeEl.height;
            const drawW = renderW * c.scale;
            const drawH = (elH / elW) * drawW;
            
            ctx.drawImage(activeEl, (renderW - drawW)/2 + c.posX, (renderH - drawH)/2 + c.posY, drawW, drawH);
        }
    }

    // --- LOGICA MIXER ---
    function processCommand(id) {
        if (activeEl && lastId === id) { stopAll(); return; }
        const f = document.getElementById('f' + id).files[0];
        if (!f) return;
        stopAll(); lastId = id;
        if(db) db.ref('mixer_state').set(id);
        if(!config[id]) config[id] = { posX: 0, posY: 0, scale: 1.0 };
        const url = URL.createObjectURL(f);
        if (f.type.startsWith('video')) {
            activeEl = document.createElement('video'); activeEl.src = url; activeEl.muted = true; activeEl.play();
            activeEl.onended = () => stopAll();
        } else { activeEl = new Image(); activeEl.src = url; }
    }

    function stopAll() { activeEl = null; lastId = null; if(db) db.ref('mixer_state').set(null); }

    // --- INTERACTIUNI BUTOANE ---
    window.onkeydown = (e) => { if(e.key === 'Enter') toggleFX(); };
    function toggleAI() { aiActive = !aiActive; document.getElementById('toggleAI').innerText = aiActive ? "AI: ON" : "AI: OFF"; document.getElementById('toggleAI').classList.toggle('active-ai', aiActive); }
    function toggleFX() { fxActive = !fxActive; document.getElementById('toggleFX').innerText = fxActive ? "PULS: ON" : "PULS: OFF"; document.getElementById('toggleFX').classList.toggle('active-fx', fxActive); }
    function handleBgChange(val) { if(val === 'photo') document.getElementById('bgInp').click(); }
    function loadBgImage(e) { imgBg.src = URL.createObjectURL(e.target.files[0]); }

    // --- CONTROALE MOUSE (DRAG & SCALE) ---
    let isDragging = false;
    canvas.onmousedown = () => isDragging = true;
    window.onmouseup = () => { isDragging = false; localStorage.setItem('mixer_config_v16', JSON.stringify(config)); };
    window.onmousemove = (e) => {
        if(isDragging && lastId) {
            const factor = renderW / canvas.clientWidth;
            config[lastId].posX += e.movementX * factor;
            config[lastId].posY += e.movementY * factor;
        }
    };
    window.onwheel = (e) => {
        if(lastId) {
            e.preventDefault();
            config[lastId].scale -= e.deltaY * 0.001;
            config[lastId].scale = Math.max(0.05, Math.min(5, config[lastId].scale));
        }
    };

    // --- FIREBASE SETUP ---
    function setupFirebase() {
        const k = prompt("API Key:"), u = prompt("Database URL:");
        if(k && u) { localStorage.setItem('fb_k', k); localStorage.setItem('fb_u', u); location.reload(); }
    }
    const k = localStorage.getItem('fb_k'), u = localStorage.getItem('fb_u');
    if(k && u) {
        firebase.initializeApp({apiKey: k, databaseURL: u}); db = firebase.database();
        const st = document.getElementById('status');
        st.innerText = "ONLINE ✅"; st.style.background = "#113311"; st.style.color = "#2ed573";
        db.ref('mixer_cmd').on('value', snap => { if(snap.val()) processCommand(snap.val().id); });
    }
    initCamera();
</script>
</body>
</html>
