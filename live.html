<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Mixer Studio V18 - Fix Final</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { background: #000; color: white; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: #151515; border-right: 1px solid #333; padding: 10px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; font-size: 11px; }
        .main-stage { flex-grow: 1; display: flex; justify-content: center; align-items: center; background: #050505; }
        #canvas-container { height: 95vh; aspect-ratio: 9 / 16; position: relative; background: #111; border: 1px solid #444; }
        canvas { width: 100%; height: 100%; }
        .card { background: #222; padding: 10px; border-radius: 6px; margin-bottom: 5px; border-left: 3px solid #007bff; }
        button { width: 100%; padding: 8px; cursor: pointer; background: #333; color: white; border: 1px solid #444; border-radius: 4px; font-weight: bold; font-size: 11px; margin-top: 5px; }
        #status { text-align: center; font-weight: bold; padding: 5px; border-radius: 4px; font-size: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div id="status" style="background: #221111; color: #ff4444;">OFFLINE</div>
    
    <div class="card">
        <strong>1. CAMERA:</strong>
        <select id="videoSource" onchange="startCamera()" style="width:100%; background:#000; color:#fff; padding:5px;"></select>
        <button onclick="startCamera()" style="background: #2ed573; color: #000;">RESTART CAMERA</button>
    </div>

    <div class="card" style="border-left-color: #ff0050;">
        <strong>2. EFECT PULS (ENTER):</strong>
        <button id="toggleFX" onclick="toggleFX()">PULS: OFF</button>
        <input type="range" id="fxPower" min="0" max="150" value="50" style="width:100%">
    </div>

    <div class="card">
        <strong>3. FUNDAL:</strong>
        <select id="bgSource" id="bgSource" style="width:100%; background:#000; color:#fff; padding:5px;">
            <option value="black">Negru</option>
            <option value="green">Verde (Chroma)</option>
        </select>
    </div>

    <div class="card">
        <strong>4. SLOTURI (1-10):</strong>
        <button onclick="setupFirebase()" style="background:#444">⚙️ CONFIG FIREBASE</button>
        <div id="file-slots"></div>
    </div>
</div>

<div class="main-stage">
    <div id="canvas-container">
        <canvas id="c_out"></canvas>
    </div>
</div>

<video id="v_raw" autoplay muted playsinline style="display:none"></video>

<script>
    const video = document.getElementById('v_raw');
    const canvas = document.getElementById('c_out');
    const ctx = canvas.getContext('2d');
    
    let db, activeEl = null, lastId = null;
    let fxActive = false;
    const renderW = 1080, renderH = 1920;
    let config = JSON.parse(localStorage.getItem('mixer_config_v18')) || {};

    const slotsDiv = document.getElementById('file-slots');
    for(let i=1; i<=10; i++) {
        slotsDiv.innerHTML += `<div style="margin-top:5px;">#${i}: <input type="file" id="f${i}" style="font-size:10px; width:100%"></div>`;
    }

    async function init() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const select = document.getElementById('videoSource');
        devices.forEach(d => { if(d.kind==='videoinput'){ 
            let o = document.createElement('option'); o.value = d.deviceId; o.text = d.label || 'Camera ' + (select.length + 1); 
            select.appendChild(o); 
        }});
        startCamera();
    }

    async function startCamera() {
        if (window.stream) window.stream.getTracks().forEach(t => t.stop());
        const id = document.getElementById('videoSource').value;
        // Folosim setari flexibile pentru a evita ecranul negru
        const constraints = { video: { deviceId: id ? {exact: id} : undefined } };
        
        try {
            const s = await navigator.mediaDevices.getUserMedia(constraints);
            window.stream = s;
            video.srcObject = s;
            video.play();
            drawLoop();
        } catch (e) {
            console.error("Camera error:", e);
            alert("Nu s-a putut porni camera. Verifica permisiunile!");
        }
    }

    function drawLoop() {
        canvas.width = renderW; canvas.height = renderH;

        // 1. Fundal
        ctx.fillStyle = document.getElementById('bgSource').value === 'green' ? "#00ff00" : "#000";
        ctx.fillRect(0,0,renderW,renderH);

        // 2. Camera cu Crop automat (sa nu se vada negru)
        if (video.readyState >= 2) {
            ctx.save();
            let fX = 0, fY = 0, fW = renderW, fH = renderH;

            // Logica Puls
            if(fxActive) {
                const t = Date.now() * 0.005;
                const p = document.getElementById('fxPower').value;
                const pulse = Math.sin(t * 2) * p;
                fX = (Math.cos(t * 1.5) * (p/2)) - (pulse/2);
                fY = (Math.sin(t * 1.2) * (p/2)) - (pulse/2);
                fW = renderW + pulse; fH = renderH + (pulse * 1.77);
            }

            // Calculam proportia sa umplem ecranul indiferent de camera
            let vW = video.videoWidth;
            let vH = video.videoHeight;
            let ratio = vW / vH;
            let targetRatio = renderW / renderH;

            if (ratio > targetRatio) {
                // Video e prea lat
                let sw = vH * targetRatio;
                let sx = (vW - sw) / 2;
                ctx.drawImage(video, sx, 0, sw, vH, fX, fY, fW, fH);
            } else {
                // Video e prea inalt
                let sh = vW / targetRatio;
                let sy = (vH - sh) / 2;
                ctx.drawImage(video, 0, sy, vW, sh, fX, fY, fW, fH);
            }
            ctx.restore();
        }

        // 3. Documente
        if (activeEl && lastId) {
            const c = config[lastId] || { posX: 0, posY: 0, scale: 1.0 };
            const elW = activeEl.videoWidth || activeEl.width;
            const elH = activeEl.videoHeight || activeEl.height;
            const dW = renderW * c.scale;
            const dH = (elH / elW) * dW;
            ctx.drawImage(activeEl, (renderW - dW)/2 + c.posX, (renderH - dH)/2 + c.posY, dW, dH);
        }
        requestAnimationFrame(drawLoop);
    }

    function processCommand(id) {
        if (activeEl && lastId === id) { stopAll(); return; }
        const f = document.getElementById('f' + id).files[0];
        if (!f) return;
        stopAll(); lastId = id;
        if(db) db.ref('mixer_state').set(id);
        const url = URL.createObjectURL(f);
        if (f.type.startsWith('video')) {
            activeEl = document.createElement('video'); activeEl.src = url; activeEl.muted = true; activeEl.play();
            activeEl.onended = () => stopAll();
        } else { activeEl = new Image(); activeEl.src = url; }
    }

    function stopAll() { activeEl = null; lastId = null; if(db) db.ref('mixer_state').set(null); }
    window.onkeydown = (e) => { if(e.key === 'Enter') toggleFX(); };
    function toggleFX() { fxActive = !fxActive; document.getElementById('toggleFX').innerText = fxActive ? "PULS: ON" : "PULS: OFF"; }

    // Mouse Controls
    let isDrag = false;
    canvas.onmousedown = () => isDrag = true;
    window.onmouseup = () => { isDrag = false; localStorage.setItem('mixer_config_v18', JSON.stringify(config)); };
    window.onmousemove = (e) => {
        if(isDrag && lastId) {
            if(!config[lastId]) config[lastId] = { posX: 0, posY: 0, scale: 1.0 };
            const factor = renderW / canvas.clientWidth;
            config[lastId].posX += e.movementX * factor;
            config[lastId].posY += e.movementY * factor;
        }
    };
    window.onwheel = (e) => {
        if(lastId) {
            e.preventDefault();
            if(!config[lastId]) config[lastId] = { posX: 0, posY: 0, scale: 1.0 };
            config[lastId].scale -= e.deltaY * 0.001;
            config[lastId].scale = Math.max(0.05, Math.min(5, config[lastId].scale));
        }
    };

    function setupFirebase() {
        const k = prompt("API Key:"), u = prompt("Database URL:");
        if(k && u) { localStorage.setItem('fb_k', k); localStorage.setItem('fb_u', u); location.reload(); }
    }
    const k = localStorage.getItem('fb_k'), u = localStorage.getItem('fb_u');
    if(k && u) {
        firebase.initializeApp({apiKey: k, databaseURL: u}); db = firebase.database();
        const st = document.getElementById('status'); st.innerText = "ONLINE ✅"; st.style.background = "#113311"; st.style.color = "#2ed573";
        db.ref('mixer_cmd').on('value', snap => { if(snap.val()) processCommand(snap.val().id); });
    }
    init();
</script>
</body>
</html>
