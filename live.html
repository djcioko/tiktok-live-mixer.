<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>MIXER VIDEO VERTICAL</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { background: #000; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; color: white; overflow: hidden; }
        #canvas-container { position: relative; width: 450px; height: 800px; background: #111; border: 2px solid #333; }
        video, canvas { position: absolute; width: 100%; height: 100%; top: 0; left: 0; object-fit: cover; }
        #settings-ui { position: fixed; right: 0; top: 0; width: 250px; background: rgba(0,0,0,0.8); padding: 15px; font-size: 12px; display: none; }
        input { width: 90%; background: #222; color: white; border: 1px solid #444; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="canvas-container">
        <video id="cam" autoplay playsinline></video>
        <canvas id="stage"></canvas>
    </div>

    <button onclick="toggleSet()" style="position:fixed; bottom:10px; right:10px; opacity:0.3;">⚙️</button>

    <div id="settings-ui" id="ui">
        <h3>CONFIG MIXER</h3>
        <input type="text" id="fbK" placeholder="Firebase Key">
        <input type="text" id="fbU" placeholder="Firebase URL">
        <hr>
        <p>Căi Video (ex: file:///C:/vids/1.mp4)</p>
        <div id="paths"></div>
        <button onclick="saveAll()" style="width:100%; background:blue; color:white;">SALVEAZĂ TOT</button>
    </div>

    <video id="hiddenVid" style="display:none;"></video>

    <script>
        const cam = document.getElementById('cam');
        const stage = document.getElementById('stage');
        const ctx = stage.getContext('2d');
        const hiddenVid = document.getElementById('hiddenVid');
        let db;

        // 1. Camera
        navigator.mediaDevices.getUserMedia({ video: { width: 1080, height: 1920 } }).then(s => cam.srcObject = s);

        // 2. Setări și Firebase
        function toggleSet() { const u = document.getElementById('settings-ui'); u.style.display = u.style.display === 'block' ? 'none' : 'block'; }
        
        window.onload = () => {
            const k = localStorage.getItem('fb_k'), u = localStorage.getItem('fb_u');
            if(k && u) { 
                document.getElementById('fbK').value = k; document.getElementById('fbU').value = u;
                firebase.initializeApp({ apiKey: k, databaseURL: u });
                db = firebase.database();
                db.ref('mixer_cmd').on('value', snap => { if(snap.val()) playFX(snap.val().id); });
            }
            // Generează câmpuri pentru 10 videouri
            let html = '';
            for(let i=1; i<=10; i++) {
                let val = localStorage.getItem('path_'+i) || '';
                html += `${i}: <input type="text" id="p${i}" value="${val}"><br>`;
            }
            document.getElementById('paths').innerHTML = html;
        };

        function saveAll() {
            localStorage.setItem('fb_k', document.getElementById('fbK').value);
            localStorage.setItem('fb_u', document.getElementById('fbU').value);
            for(let i=1; i<=10; i++) localStorage.setItem('path_'+i, document.getElementById('p'+i).value);
            location.reload();
        }

        function playFX(id) {
            const path = localStorage.getItem('path_'+id);
            if(!path) return;
            hiddenVid.src = path;
            hiddenVid.play();
            draw();
        }

        function draw() {
            if(hiddenVid.paused || hiddenVid.ended) { ctx.clearRect(0,0,stage.width,stage.height); return; }
            stage.width = 450; stage.height = 800;
            ctx.drawImage(hiddenVid, 0, 0, 450, 800);
            
            let frame = ctx.getImageData(0,0,450,800);
            for (let i = 0; i < frame.data.length; i += 4) {
                let r = frame.data[i], g = frame.data[i+1], b = frame.data[i+2];
                // Chroma Key simplu (verde)
                if (g > 120 && g > r * 1.2 && g > b * 1.2) frame.data[i+3] = 0;
            }
            ctx.putImageData(frame, 0, 0);
            requestAnimationFrame(draw);
        }
    </script>
</body>
</html>
